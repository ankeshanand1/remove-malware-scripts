#!/bin/bash

# ----------------------------------
# Colors
# ----------------------------------
NC='\033[0m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'

i=1
sp="/-\|"

sleep 1
echo "-------------------------------------"
echo "        Quick Malware Killer         "
echo "Author: ankeshanand1                 "
echo "Copyright: GNU General Public License"
echo "Supported OS: CentOS7, CentOS8       "
echo "Version: 1.0.0                       "
echo "Release Date: 04 December 2021       "
echo "Credits: Github                      "
echo "Engines: ClamAV, RKhunter            "
echo "-------------------------------------"
sleep 1

echo ""
if ping -q -c 1 -W 1 google.com >/dev/null; then
echo -e "${GREEN}Internet Connection Successful...${NC}"
else
  echo ""
  echo -e "${RED}Seems like Network has some problems, Trying Auto-Fix${NC}"
  if ping -q -c 1 -W 1 8.8.8.8 >/dev/null; then
  echo -e "${GREEN}Network is OK, DNS Got some Problems...${NC}"
  echo "nameserver 8.8.8.8" >> /etc/resolv.conf
  echo "nameserver 8.8.4.4" >> /etc/resolv.conf
  echo "nameserver 1.1.1.1" >> /etc/resolv.conf
  echo -e "${GREEN}Fixed DNS,Retrying Network Check...${NC}"
  echo ""
  if ping -q -c 1 -W 1 google.com >/dev/null; then
  echo -e "${GREEN}Network Connection Successful${NC}"
  else
  echo -e "${RED}Network is Offline. We have tried a Fix from our side${NC}"
  echo -e "${RED}but didn't work. Please Check the Network!${NC}"
  exit 1
  fi
  else
  echo -e "${RED}Network is Offline. Troubleshooting Network!${NC}"
  sudo dhclient -v > /dev/null
  sudo systemctl restart network
  echo -e "${GREEN}Fixed Network, Retrying Network Check${NC}"
  echo ""
  if ping -q -c 1 -W 1 google.com >/dev/null; then
  echo -e "${GREEN}Network Connection Successful${NC}"
  else
  echo -e "${RED}Network is Offline. We have tried a Fix from our side${NC}"
  echo -e "${RED}but didn't work. Please Check the Network!${NC}"
  exit 1
  fi
  fi
fi

echo ""
echo -e "${YELLOW}Updating System${NC}"
sudo yum -y update --exclude=kernel*

echo ""
if [ $? != 0 ]; 
then
echo -e "${RED}Seems like YUM is experiencing Error. No Worries,${NC}"
echo -e "${RED}Trying a Fix${NC}"
sudo rm -rf /var/cache/yum
sudo yum clean all > /dev/null 2>&1
echo ""
echo -e "${YELLOW}Trying System Update Again${NC}"
sudo yum -y update --exclude=kernel*
fi
echo ""

if ! command -v rkhunter &> /dev/null
then
echo -e "${YELLOW}Installing Rootkit Scanner${NC}"
sudo yum -y install epel-release > /dev/null 2>&1
sudo yum -y install tar >/dev/null 2>&1
sudo yum -y install wget > /dev/null 2>&1
sudo yum -y install rkhunter > /dev/null
sudo rkhunter --propupd
fi

if command -v rkhunter &> /dev/null
then
echo ""
echo -e "${YELLOW}Killing Rootkits${NC}"
sudo rkhunter --checkall --sk
else
echo -e "${RED}RootKit Scanner Installation failed${NC}"
fi

if ! command -v freshclam &> /dev/null
then
echo ""
echo -e "${YELLOW}Installing Antivirus${NC}"
sudo yum -y install clamav-server clamav-data clamav-update clamav-filesystem clamav clamav-scanner-systemd clamav-devel clamav-lib clamav-server-systemd > /dev/null 2>&1
sudo freshclam > /dev/null 2>&1
sudo /etc/init.d/clamav-freshclam stop > /dev/null 2>&1
sudo freshclam > /dev/null 2>&1
sudo /etc/init.d/clamav-freshclam start > /dev/null 2>&1
fi

if command -v freshclam &> /dev/null
then
echo ""
echo -e "${YELLOW}Killing Malwares if found...${NC}"
sudo clamscan --remove=yes -i -r ~/
else
echo -e "${RED}Antivirus Installation failed${NC}"
fi

echo ""
echo -e "${GREEN}All Done...Goodbye!${NC}"
exit 1
